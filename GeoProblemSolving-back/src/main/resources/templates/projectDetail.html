<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <link rel="shortcut icon" href="/GeoProblemSolving/static/favicon.ico">
    <title th:text="${projectInfo.name}+' | Geo-ProblemSolving'"></title>
    <meta http-equiv="Content-Type" content=" charset=UTF-8"/>
    <meta name="description" th:attr="content=${projectInfo.description}">
    <meta name="keywords" th:attr="content=${projectInfo.tag}">
    <meta name="author" content="OpenGMS">
    <script src="/GeoProblemSolving/js/jquery.js"></script>
    <script src="/GeoProblemSolving/js/vue.min.js"></script>
    <script src="/GeoProblemSolving/js/crypto-js.js"></script>
    <link href="/GeoProblemSolving/css/iview.css" rel="stylesheet">
    <script src="/GeoProblemSolving/js/iview.js"></script>
    <script src="/GeoProblemSolving/js/vue-avatar.min.js"></script>
    <script src="/GeoProblemSolving/js/axios.min.js"></script>
    <link href="/GeoProblemSolving/css/vuescroll.css" rel="stylesheet">
    <script src="/GeoProblemSolving/js/vuescroll.js"></script>
    <script src="/GeoProblemSolving/js/Sortable.min.js"></script>
    <script src="/GeoProblemSolving/js/vuedraggable.umd.min.js"></script>
    <link href="/GeoProblemSolving/jspanel/jspanel.css" rel="stylesheet">
    <script src="/GeoProblemSolving/jspanel/jspanel.js"></script>
    <script src="/GeoProblemSolving/jspanel/extensions/modal/jspanel.modal.js"></script>
    <script src="/GeoProblemSolving/jspanel/extensions/tooltip/jspanel.tooltip.js"></script>
    <script src="/GeoProblemSolving/jspanel/extensions/hint/jspanel.hint.js"></script>
    <script src="/GeoProblemSolving/jspanel/extensions/layout/jspanel.layout.js"></script>
    <script src="/GeoProblemSolving/jspanel/extensions/contextmenu/jspanel.contextmenu.js"></script>
    <script src="/GeoProblemSolving/jspanel/extensions/dock/jspanel.dock.js"></script>
    <script src="/GeoProblemSolving/customize/userRole.js"></script>
    <script th:replace="navigation::commonHeader-css"></script>
    <script th:replace="navigation::commonHeader-html"></script>
    <script th:replace="navigation::commonHeader-js"></script>
    <script th:replace="folderTree::common-css"></script>
    <script th:replace="folderTree::common-html"></script>
    <script th:replace="folderTree::common-js"></script>
    <script th:replace="taskManager::task-css"></script>
    <script th:replace="taskManager::task-html"></script>
    <script th:replace="taskManager::task-js"></script>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
    <style>
        #projectDetailPage {
            min-width: 1100px;
        }

        .projectMenuItem {
            margin: 0 0 10px 0;
        }

        .projectMenuItemTitle {
            display: inline-block;
            color: #2d8cf099;
        }

        .ivu-card-body {
            display: flex;
            flex-flow: column;
            flex: 1;
        }

        .flex1 {
            display: flex;
            flex-flow: column;
            flex: 1;
        }

        .projectDescriptionContent {
            height: calc(100vh - 530px);
            overflow-y: auto;
            padding: 10px 5px;
            word-break: break-word;
        }

        .statistics {
            /* width: 40%; */
            height: -webkit-fill-available;
            display: inline-block;
        }

        .statistics p {
            margin-top: 5px;
        }

        .showCount {
            font-size: 30px;
            vertical-align: middle;
            margin-left: 15px;
        }

        .changeEditColor:hover {
            background-color: #2db7f5;
            color: white;
        }

        .changeRemoveColor:hover {
            background-color: #ed4014;
            color: white;
        }

        .changeInviteColor:hover {
            background-color: #19be6b;
            color: white;
        }

        .overEllipsis {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .subProjectDes {
            text-indent: 2em;
            height: 150px;
            display: -webkit-box;
            word-break: break-all;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 7;
            overflow: hidden;
            white-space: pre-line;
        }

        .subProjectExtraP {
            display: flex;
            flex-flow: row;
        }

        .subProjectExtraSpan {
            display: inline-block;
            vertical-align: top;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .subProjectCard .ivu-card-extra {
            top: 10px;
        }

        .demo-upload-list {
            display: inline-block;
            width: 60px;
            height: 60px;
            text-align: center;
            line-height: 60px;
            border: 1px solid transparent;
            border-radius: 4px;
            overflow: hidden;
            background: #fff;
            position: relative;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            margin-right: 4px;
        }

        .demo-upload-list img {
            width: 100%;
            height: 100%;
        }

        .demo-upload-list-cover {
            display: none;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
        }

        .demo-upload-list:hover .demo-upload-list-cover {
            display: block;
        }

        .demo-upload-list-cover i {
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            margin: 0 2px;
        }

        .uploadAvatar {
            position: relative;
            width: 58px;
            height: 58px;
            top: 0;
            left: 0;
            outline: none;
            background-color: transparent;
            opacity: 0;
        }

        .uploadBox {
            display: inline-block;
            width: 58px;
            height: 58px;
            line-height: 58px;
            border-width: 0.75px;
            border-style: dashed;
            border-color: lightslategray;
        }

        .inline_style {
            display: flex;
        }

        .fileBtn {
            margin: 0px 3px;
        }

        .fileBtnHoverBlue:hover {
            background-color: #2db7f5;
            color: white;
        }

        .ivu-card-body {
            display: inherit;
        }

        .btnHoverRed:hover {
            background-color: #ed4014;
            color: white;
        }

        .project_title {
            font-size: 1.5rem;
            color: rgba(214, 109, 0, 0.82);
            display: contents;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media screen and (min-width: 1300px) {
            .title_mw {
                max-width: 600px;
            }
        }

        @media screen and (max-width: 1299px) {
            .title_mw {
                max-width: 350px;
            }
        }
    </style>
</head>

<body id="pageBody">
<div id="projectDetailPage" v-cloak>
    <child-navigation ref="navigationEl" active-type="projects" :user-info="userInfo"></child-navigation>
    <template>
        <div :style="{height: contentPageCSS}" style="margin-top: 60px;">
            <div span="2" style="height: inherit;width: 90px;position: absolute;">
                <i-menu :active-name="activeMenu" @on-select="changeMenuItem"
                        style="height: inherit;width: fit-content;z-index:98">
                    <menu-item name="overview" class="projectMenuItem">
                        <Icon type="md-home" title="Overview" size="35"></Icon>
                    </menu-item>
                    <menu-item name="info" class="projectMenuItem">
                        <Icon type="ios-information-circle" title="Information" size="35"></Icon>
                    </menu-item>
                    <menu-item name="task" class="projectMenuItem">
                        <Icon type="md-calendar" title="Tasks" size="35"></Icon>
                    </menu-item>
                    <menu-item name="workspace" class="projectMenuItem">
                        <Icon type="md-git-branch" title="Workspace" size="35"></Icon>
                    </menu-item>
                    <menu-item name="resource" class="projectMenuItem">
                        <Icon type="ios-folder" title="Resources" size="35"></Icon>
                    </menu-item>
                </i-menu>
            </div>
            <div style="margin-left: 90px;height: inherit;min-height: fit-content;">
                <div v-show="activeMenu=='overview'" style="height: inherit;min-height: fit-content;">
                    <div style="background:#eee;padding: 10px;height: inherit;min-height: fit-content;">
                        <Card :bordered="false" dis-hover
                              style="height: -webkit-fill-available; flex-flow: column;min-height: fit-content;">
                            <div slot="title">
                                <!--                                <h1 class="projectMenuItemTitle">Overview </h1>-->
                                <div style="margin-left:20px;top: 15px; position:absolute;left:50px;">
                                    <strong style="font-size:1.5rem;">Project</strong>
                                    <Divider type="vertical"></Divider>
                                    <strong style="font-size:1rem;">Overview</strong>
                                </div>
                                <div style="display:flex;align-items:center;justify-content:center;">
                                    <span class="project_title title_mw">{{projectInfo.name}}</span>
                                </div>
                            </div>
                            <div slot="extra">
                                <div v-if="userRole == 'visitor'">
                                    <i-button
                                            type="success"
                                            @click="joinApplyModalShow()"
                                            title="Apply to join the project"
                                    >Apply to join
                                    </i-button>
                                </div>
                            </div>
                            <Row style="margin-left:60px">
                                <i-col span="10" offset="1">
                                    <div style="margin:20px">
                                        <Card style="width:100%;height:10%">
                                            <div style="text-align:center;margin-bottom:15px;font-weight:bold;font-size:26px"
                                            >Introduction
                                            </div>
                                            <div style="text-align:center; width:40%; float:left">
                                                <img src="/GeoProblemSolving/Images/info.png"/>
                                            </div>
                                            <div style="width:60%; float:left; min-height: 90px">
                                                <ul>
                                                    <li>The description of this project</li>
                                                    <li>The introduction of this project</li>
                                                    <li>Some details about this project</li>
                                                    <li>The participant list of this project</li>
                                                </ul>
                                            </div>
                                            <div style="text-align:center">
                                                <h3>
                                                    <a @click="changeMenuItem('info')">Click to check it</a>
                                                </h3>
                                            </div>
                                        </Card>
                                    </div>
                                </i-col>
                                <i-col span="10" offset="1">
                                    <div style="margin:20px">
                                        <Card style="width:100%">
                                            <div style="text-align:center;margin-bottom:15px;font-weight:bold;font-size:26px"
                                            >Task assignment
                                            </div>
                                            <div style="text-align:center; width:40%; float:left">
                                                <img src="/GeoProblemSolving/Images/tasks.png"/>
                                            </div>
                                            <div style="width:60%; float:left; min-height: 90px">
                                                <ul>
                                                    <li>"To do" list: tasks that need to be done</li>
                                                    <li>"Doing" list: tasks that are being done</li>
                                                    <li>"Done" list: tasks that have been done</li>
                                                    <li>Task schedule for solving geo-problems</li>
                                                </ul>
                                            </div>
                                            <div style="text-align:center">
                                                <h3>
                                                    <a @click="changeMenuItem('task')">Click to check it</a>
                                                </h3>
                                            </div>
                                        </Card>
                                    </div>
                                </i-col>
                                <i-col span="10" offset="1">
                                    <div style="margin:20px">
                                        <Card style="width:100%">
                                            <div style="text-align:center;margin-bottom:15px;font-weight:bold;font-size:26px"
                                            >Workspace
                                            </div>
                                            <div style="text-align:center; width:40%; float:left">
                                                <img src="/GeoProblemSolving/Images/steps.jpg"/>
                                            </div>
                                            <div style="width:60%; float:left; min-height: 90px">
                                                <ul>
                                                    <li>Create a subproject with iterative step</li>
                                                    <li>Create a step directly</li>
                                                    <li>Start to work with other participants directly</li>
                                                </ul>
                                            </div>
                                            <div style="text-align:center">
                                                <h3>
                                                    <a @click="changeMenuItem('workspace')">Click to check it</a>
                                                </h3>
                                            </div>
                                        </Card>
                                    </div>
                                </i-col>
                                <i-col span="10" offset="1">
                                    <div style="margin:20px">
                                        <Card style="width:100%">
                                            <div style="text-align:center;margin-bottom:15px;font-weight:bold;font-size:26px"
                                            >Resources
                                            </div>
                                            <div style="text-align:center; width:40%; float:left">
                                                <img src="/GeoProblemSolving/Images/data.png"/>
                                            </div>
                                            <div style="width:60%; float:left; min-height: 90px">
                                                <ul>
                                                    <li>Collect different types of resources</li>
                                                    <li>Support context understanding</li>
                                                    <li>Support data processing</li>
                                                    <li>Support modeling and analysis</li>
                                                </ul>
                                            </div>
                                            <div style="text-align:center">
                                                <h3>
                                                    <a @click="changeMenuItem('resource')">Click to check it</a>
                                                </h3>
                                            </div>
                                        </Card>
                                    </div>
                                </i-col>
                                <i-col span="24">
                                    <div style="text-align: center">
                                        <span style="margin:25px 0; font-size:24px">Project</span>
                                        <span style="margin: 0px 10px; font-size: 14px;"> is created for dealing with geo-problems in a participatory manner. </span>
                                    </div>
                                </i-col>
                            </Row>
                        </Card>
                    </div>
                </div>
                <div v-show="activeMenu=='info'" style="height: inherit;min-height: fit-content;">
                    <div style="background:#eee;padding: 10px;height: inherit;min-height: fit-content;">
                        <Card :bordered="false" dis-hover
                              style="height: -webkit-fill-available;flex-flow: column;min-height: fit-content;">
                            <div slot="title">
                                <!--                                <h1 slot="title" class="projectMenuItemTitle">Introduction</h1>-->
                                <div style="margin-left:20px;top: 15px; position:absolute;left:50px;">
                                    <strong style="font-size:1.5rem;">Project</strong>
                                    <Divider type="vertical"></Divider>
                                    <strong style="font-size:1rem;">Introduction</strong>
                                </div>
                                <div style="display:flex;align-items:center;justify-content:center;">
                                    <span class="project_title title_mw">{{projectInfo.name}}</span>
                                </div>
                            </div>
                            <div slot="extra">
                                <div>
                                    <Poptip trigger="hover" content="Edit project information" placement="left"
                                            v-if="permissionIdentity('edit_info')">
                                        <i-button style="margin: 0 5px;" class="changeEditColor"
                                                  @click="editModelShow()">
                                            <Icon type="ios-create" :size="20"></Icon>
                                        </i-button>
                                    </Poptip>
                                    <Poptip trigger="hover" content="Remove project" placement="left"
                                            v-if="userRole == 'manager'">
                                        <i-button style="margin: 0 5px;" class="changeRemoveColor"
                                                  @click="deleteProjectShow()">
                                            <Icon type="md-close" :size="20"></Icon>
                                        </i-button>
                                    </Poptip>
                                </div>
                                <div v-if="userRole == 'visitor'">
                                    <i-button
                                            type="success"
                                            @click="joinApplyModalShow()"
                                            title="Apply to join the project"
                                    >Apply to join
                                    </i-button>
                                </div>
                            </div>
                            <div class="flex1" style="min-height: fit-content;">
                                <Row gutter="25" style="flex: 1;display: flex;flex-flow: initial">
                                    <i-col span="16" style="display: flex;flex-flow: column">
                                        <div style="border: solid 1px #eeeeee;flex: 1;padding: 20px;flex-flow: column;display: flex;">
                                            <Row gutter="15" style="height: 200px;display: flex;">
                                                <i-col span="8">
                                                    <div style="width: 200px;height: 200px;">
                                                        <img :src="projectInfo.picture"
                                                             style="height: inherit;width: inherit;"
                                                             v-if="projectInfo.picture!=''&&projectInfo.picture!=undefined"
                                                        />
                                                        <avatar :username="projectInfo.name" :size="200"
                                                                :title="projectInfo.name" :rounded="false"
                                                                v-else></avatar>
                                                    </div>
                                                </i-col>
                                                <i-col span="16" style="align-self: flex-end;">
                                                    <div style="height: -webkit-fill-available;text-align: center;">
                                                        <div class="statistics">
                                                            <div style="text-align: left;padding: 5px;">
                                                                <p><strong>Title: </strong><span id="projectTitle"
                                                                                                 th:text="${projectInfo.name}">Project name</span>
                                                                </p>
                                                                <p><strong>Privacy: </strong><span id="projectPrivacy"
                                                                                                   th:text="${projectInfo.privacy}">Project privacy</span>
                                                                    <span style="margin-left: 10px; cursor: pointer"
                                                                          title="Modify the permission of participants"
                                                                          v-if="userRole == 'manager'"
                                                                          @click="modifyPermission">
                                                                       <Icon type="md-cog" size="16"
                                                                             color="grey"></Icon>
                                                                    </span>
                                                                </p>
                                                                <p><strong>Category: </strong><span id="projectCategory"
                                                                                                    th:text="${projectInfo.category}">Project category</span>
                                                                </p>
                                                                <p><strong>Tag: </strong><span id="projectTag"
                                                                                               class="overEllipsis"
                                                                                               style="display: inline-block;vertical-align: top;width:230px"
                                                                                               th:text="${projectInfo.tag}"
                                                                                               th:attr="title=${projectInfo.tag}">Project tag</span>
                                                                </p>
                                                                <!--                                                                <p><strong>Manager: </strong>-->
                                                                <!--                                                                    {{projectInfo.managerName}}-->
                                                                <!--                                                                </p>-->
                                                                <p><strong>Create time: </strong>
                                                                    {{projectInfo.createdTime}}</p>
                                                            </div>
                                                        </div>
                                                        <div style="position: absolute;right: 5px;bottom: 5px;">
                                                            <div>
                                                                <Icon type="md-git-branch" size="30"></Icon>
                                                                <span class="showCount">{{SubProjectCount()}}</span>
                                                            </div>
                                                            <div>
                                                                <Icon type="md-contacts" size="30"></Icon>
                                                                <span class="showCount">{{ParticipantsCount()}}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </i-col>
                                            </Row>
                                            <div class="flex1" style="margin-top: 10px;">
                                                <div style="flex: 1;padding: 5px;min-height: 100px;border: #e8eaec 0.1px dashed;">
                                                    <h3>Description:</h3>
                                                    <div class="projectDescriptionContent">
                                                        <vue-scroll :ops="scrollOps">
                                                            <div id="projectDescription" style="white-space: pre-line;"
                                                                 th:text="${projectInfo.description}">
                                                                Project description
                                                            </div>
                                                        </vue-scroll>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </i-col>
                                    <i-col span="8" style="display: flex;flex-flow: column">
                                        <div style="border: solid 1px #eeeeee;" class="flex1">
                                            <Card :bordered="false" dis-hover>
                                                <div slot="title">
                                                    <h1>Participants</h1>
                                                </div>
                                                <div slot="extra">
                                                    <div>
                                                        <Poptip trigger="hover" content="Invite members"
                                                                v-if="permissionIdentity('invite_member')"
                                                                placement="left">
                                                            <i-button class="changeInviteColor"
                                                                      @click="inviteModalShow()">
                                                                <Icon type="md-person-add" :size="20"></Icon>
                                                            </i-button>
                                                        </Poptip>
                                                        <Poptip trigger="hover" content="Remove members"
                                                                v-if="permissionIdentity('manage_member')"
                                                                placement="left">
                                                            <i-button style="margin-left:5px;"
                                                                      class="changeRemoveColor"
                                                                      @click="deleteMemberModelShow">
                                                                <Icon type="md-remove-circle" :size="20"></Icon>
                                                            </i-button>
                                                        </Poptip>
                                                    </div>
                                                </div>
                                                <!--                                                <div :style="{height: membersContentCSS}" style="overflow-y:auto;">-->
                                                <!--                                                    <vue-scroll :ops="scrollOps">-->
                                                <!--                                                        <Card style="background-color: #dcdee2;border-color: #c5c8ce;cursor: pointer;"-->
                                                <!--                                                              @click.native=goPersonalPage(projectInfo.managerId)>-->
                                                <!--                                                            <div title="Manager">-->
                                                <!--                                                                <h2 style="color: white" class="overEllipsis">-->
                                                <!--                                                                    {{projectInfo.managerName}}</h2>-->
                                                <!--                                                            </div>-->
                                                <!--                                                        </Card>-->
                                                <!--                                                        <Card v-for="member in projectInfo.members"-->
                                                <!--                                                              style="margin-top: 5px;cursor: pointer;"-->
                                                <!--                                                              @click.native=goPersonalPage(member.userId)>-->
                                                <!--                                                            <div title="Member">-->
                                                <!--                                                                <h2 class="overEllipsis">{{member.userName}}</h2>-->
                                                <!--                                                            </div>-->
                                                <!--                                                        </Card>-->
                                                <!--                                                    </vue-scroll>-->
                                                <!--                                                </div>-->
                                            </Card>
                                        </div>
                                    </i-col>
                                </Row>
                            </div>
                        </Card>
                    </div>
                </div>
                <div v-show="activeMenu=='workspace'" style="height: inherit;min-height: fit-content;">
                    <div style="background:#eee;padding: 10px;height: inherit;min-height: fit-content;">
                        <div style="width: -webkit-fill-available;height: -webkit-fill-available;">
                            <iframe style="width: -webkit-fill-available;height: -webkit-fill-available;border-width:0"
                                    :src="ipPort+'/activity/' + projectInfo.aid"></iframe>
                        </div>
                    </div>
                </div>
                <div v-show="activeMenu=='resource'" style="height: inherit;min-height: fit-content;">
                    <div style="background:#eee;padding: 10px;height: inherit;min-height: fit-content;">
                        <Card :bordered="false" dis-hover
                              style="height: -webkit-fill-available;min-height: 565px;min-height: fit-content;">
                            <!--                            <h1 slot="title" class="projectMenuItemTitle">Resources</h1>-->
                            <div slot="title">
                                <div style="margin-left:20px;top: 15px; position:absolute;left:50px;">
                                    <strong style="font-size:1.5rem;">Project</strong>
                                    <Divider type="vertical"></Divider>
                                    <strong style="font-size:1rem;">Resources</strong>
                                </div>
                                <div style="display:flex;align-items:center;justify-content:center;">
                                    <span class="project_title title_mw">{{projectInfo.name}}</span>
                                </div>
                            </div>
                            <div slot="extra">
                                <Tooltip content="Resources center" placement="left" class="fileBtn">
                                    <i-button @click="goResourceCenter" class="fileBtnHoverBlue">
                                        <Icon type="ios-albums" size="20"></Icon>
                                    </i-button>
                                </Tooltip>
                            </div>
                            <div :style="{height:workspaceCSS}">
                                <child-folder
                                        :role="userRole"
                                        :project-info="projectInfo"
                                        ref="folderTreeEl"></child-folder>
                            </div>
                        </Card>
                    </div>
                </div>
                <div v-show="activeMenu=='task'" style="height: inherit;min-height: fit-content;">
                    <div style="background:#eee;padding: 10px;height: inherit;min-height: fit-content;">
                        <Card :bordered="false" dis-hover
                              style="height: -webkit-fill-available;min-height: 565px;min-height: fit-content;">
                            <!--                            <h1 slot="title" class="projectMenuItemTitle">Task assignment</h1>-->
                            <div slot="title">
                                <div style="margin-left:20px;top: 15px; position:absolute;left:50px;">
                                    <strong style="font-size:1.5rem;">Project</strong>
                                    <Divider type="vertical"></Divider>
                                    <strong style="font-size:1rem;">Task assignment</strong>
                                </div>
                                <div style="display:flex;align-items:center;justify-content:center;">
                                    <span class="project_title title_mw">{{projectInfo.name}}</span>
                                </div>
                            </div>
                            <div>
                                <child-task
                                        :project-info="projectInfo"
                                        :user-role="userRole"
                                        ref="taskTreeEl"></child-task>
                            </div>
                        </Card>
                    </div>
                </div>
                <Modal
                        v-model="editProjectModal"
                        title="Edit project"
                        :mask-closable="false"
                        width="900"
                >
                    <div>
                        <i-form
                                ref="projectEditForm"
                                :model="projectEditForm"
                                :rules="editProjectFormRuleValidate"
                                :label-width="100"
                        >
                            <Form-item label="Title" prop="title">
                                <i-input v-model="projectEditForm.name" placeholder="Enter something..."></i-input>
                            </Form-item>
                            <Form-item label="Description" prop="description">
                                <i-input v-model="projectEditForm.description"></i-input>
                            </Form-item>
                            <Form-item label="Tag" prop="tag">
                                <i-input
                                        v-model="inputTag"
                                        placeholder="Enter some tag to introduce the project"
                                        style="margin-left:0.5%;width: 200px"
                                        @keyup.enter.native="addTag(inputTag)"
                                ></i-input>
                                <i-button
                                        icon="ios-add"
                                        type="dashed"
                                        size="small"
                                        style="margin-left:2.5%"
                                        @click="addTag(inputTag)"
                                >Add Tag
                                </i-button>
                                <Tag
                                        color="primary"
                                        v-for="(tag,index) in projectEditForm.editTags"
                                        :key="index"
                                        closable
                                        @on-close="deleteTag(index)"
                                >{{tag}}
                                </Tag>
                            </Form-item>
                            <Form-item label="Privacy" prop="privacy">
                                <Radio-group v-model="projectEditForm.privacy">
                                    <Radio
                                            label="Public"
                                            title="Other users can find the group and see who has membership."
                                    ></Radio>
                                    <Radio
                                            label="Discoverable"
                                            title="Other users can find this group, but membership information is hidden."
                                    ></Radio>
                                    <Radio label="Private" title="Other users can not find this group."></Radio>
                                </Radio-group>
                            </Form-item>
                            <Form-item prop="image" label="Image" :label-width="100">
                                <div class="inline_style">
                                    <div class="demo-upload-list" v-show="pictureUrl!=''">
                                        <div>
                                            <img v-bind:src="pictureUrl"/>
                                            <div class="demo-upload-list-cover">
                                                <Icon type="ios-eye-outline" @click.native="handleView()"></Icon>
                                                <Icon type="ios-trash-outline" @click.native="handleRemove()"></Icon>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="uploadBox">
                                        <Icon type="ios-camera" size="20" style="position:absolute;margin:18px;"></Icon>
                                        <input
                                                @change="uploadPhoto($event)"
                                                type="file"
                                                class="uploadAvatar"
                                                accept="image/*"
                                                id="choosePicture"
                                        />
                                    </div>
                                    <Modal title="View Image" v-model="visible">
                                        <img :src="pictureUrl" v-if="visible" style="width: 100%"/>
                                    </Modal>
                                </div>
                            </Form-item>
                        </i-form>
                    </div>
                    <div slot="footer" style="display: inline-block">
                        <i-button type="primary" @click="editProjectSubmit('projectEditForm')" style="float:right;">OK
                        </i-button>
                        <i-button @click="closeEditModel()" style="float:right;margin-right: 15px;">Cancel</i-button>
                    </div>
                </Modal>
                <Modal
                        v-model="removeProjectModal"
                        title="Delete warning "
                        @on-ok="deleteProject"
                        ok-text="Ok"
                        cancel-text="Cancel"
                >
                    <p>Do you sure to delete this project?</p>
                </Modal>
                <Modal
                        v-model="inviteModal"
                        title="Invite others join the Project"
                        :mask-closable="false"
                        width="800">
                    <i-form ref="emailInfo" :model="emailInfo" :rules="emailInfoRule" :label-width="200" inline>
                        <Form-item label="Recipient" prop="inputEmail" style="width:100%">
                            <Auto-complete
                                    v-model="emailInfo.inputEmail"
                                    @on-search="emialAutoFill"
                                    placeholder="input email and press enter button the email will be added below"
                                    style="width:70%"
                            >
                                <i-option v-for="item in prompt" :value="item" :key="item">{{ item }}</i-option>
                            </Auto-complete>
                        </Form-item>
                        <Form-item label="Title" prop="emailTitle" style="width:100%">
                            <i-input
                                    v-model="emailInfo.emailTitle"
                                    placeholder="set the email title to recivers by your self"
                                    style="width:70%"
                            />
                        </Form-item>
                        <Form-item label="Content" prop="emailContent" style="width:100%">
                            <i-input type="textarea" style="width:70%" :rows="4" v-model="emailInfo.emailContent"/>
                        </Form-item>
                    </i-form>
                    <div slot="footer" style="display: inline-block">
                        <i-button type="primary" @click="invite('emailInfo')" style="float:right;">Assure</i-button>
                        <i-button @click="closeInviteModel()" style="float:right;margin-right: 15px;">Cancel</i-button>
                    </div>
                </Modal>
                <Modal
                        v-model="deleteMemberModel"
                        title="Remove members from project"
                        :mask-closable="false"
                        width="600">
                    <Radio-group v-model="removeMemberName">
                        <div v-for="(member,index) in projectInfo.members" :key="index"
                             @click="getRemoveMemberId(member.userId)">
                            <Radio :label="member.userName"></Radio>
                        </div>
                    </Radio-group>
                    <div slot="footer" style="display: inline-block">
                        <i-button type="primary" @click="removeMembersAlertShow()" style="float:right;">Assure
                        </i-button>
                        <i-button @click="closeDeleteMembersModel()" style="float:right;margin-right: 15px;">Cancel
                        </i-button>
                    </div>
                </Modal>
                <Modal
                        v-model="removeMemberAlertModel"
                        title="Remove Member alert"
                        @on-ok="removeMember"
                        ok-text="OK"
                        cancel-text="Cancel">
                    <p>Do you sure to remove {{removeMemberName}} from this project?</p>
                </Modal>
                <Modal
                        v-model="createSubProjectModel"
                        title="Create a new subproject"
                        width="800"
                        :mask-closable="false">
                    <i-form
                            ref="createSubProjectForm"
                            :model="createSubProjectForm"
                            :rules="createSubprojectRuleValidate"
                            :label-width="120">
                        <Form-item label="Name" prop="subProjectTitle">
                            <i-input
                                    type="text"
                                    v-model="createSubProjectForm.subProjectTitle"
                                    placeholder="Enter subproject name (less than 60 characters) ...">
                            </i-input>
                        </Form-item>
                        <Form-item label="Description" prop="subProjectDescription">
                            <i-input
                                    v-model="createSubProjectForm.subProjectDescription"
                                    placeholder="Enter subproject description..."
                                    :rows="4"
                                    type="textarea">
                            </i-input>
                        </Form-item>
                    </i-form>
                    <div slot="footer" style="display: inline-block">
                        <i-button type="primary" @click="createSubProject('createSubProjectForm')" style="float:right;">
                            OK
                        </i-button>
                        <i-button @click="closeCreateSubProjectModel()" style="float:right;margin-right: 15px;">Cancel
                        </i-button>
                    </div>
                </Modal>
                <Modal
                        v-model="handOverModal"
                        title="Appoint a new manager"
                        with="500"
                        :mask-closable="false">
                    <h3>Please choose the new manager for this subproject.</h3>
                    <Radio-group v-model="newManagerId">
                        <Radio v-for="member in subProjectMembers" :label="member.userId">
                            {{member.userName}}
                        </Radio>
                    </Radio-group>
                    <div slot="footer" style="display: inline-block">
                        <i-button type="primary" @click="handOverAuthority()" style="float:right;">OK</i-button>
                        <i-button @click="closeHandOverModel()" style="float:right;margin-right: 15px;">Cancel
                        </i-button>
                    </div>
                </Modal>
                <Modal
                        v-model="editSubProjectModal"
                        title="Edit the information of this subproject"
                        width="800px"
                        :mask-closable="false"
                >
                    <div>
                        <i-form
                                ref="editSubProjectForm"
                                :model="editSubProjectForm"
                                :rules="editSubProjectFormRuleValidate"
                                :label-width="120"
                        >
                            <Form-item label="Name" prop="subProjectTitleEdit">
                                <i-input v-model="editSubProjectForm.subProjectTitleEdit"></i-input>
                            </Form-item>
                            <Form-item label="Description" prop="subProjectDescriptionEdit">
                                <i-input
                                        v-model="editSubProjectForm.subProjectDescriptionEdit"
                                        :rows="4"
                                        type="textarea"
                                ></i-input>
                            </Form-item>
                        </i-form>
                    </div>
                    <div slot="footer" style="display: inline-block">
                        <i-button type="primary" @click="editSubProject('editSubProjectForm')" style="float:right;">OK
                        </i-button>
                        <i-button @click="closeEditSubProjectModel()" style="float:right;margin-right: 15px;">Cancel
                        </i-button>
                    </div>
                </Modal>
                <Modal
                        v-model="deleteSubProjectModal"
                        title="Delete the subproject"
                        ok-text="OK"
                        cancel-text="Cancel"
                        @on-ok="deleteSubProject()"
                        width="600px"
                        :mask-closable="false"
                >
                    <h2>Are you sure to remove this subproject?</h2>
                    <small style="color:#03A9F4">* Once you delete the subproject, all resources and others in it will
                        disappear.
                    </small>
            </div>
            </Modal>
            <Modal
                    v-model="applyJoinSubProjectModal"
                    title="Apply to join the subproject"
                    width="800px"
                    :mask-closable="false">
                <div>
                    <i-form
                            ref="applyJoinForm"
                            :model="applyJoinForm"
                            :rules="editSubProjectFormRuleValidate"
                            :label-width="120"
                    >
                        <Form-item label="Reason" prop="reasonDescription">
                            <i-input
                                    v-model="applyJoinForm.reasonDescription"
                                    :rows="4"
                                    type="textarea"
                            ></i-input>
                        </Form-item>
                    </i-form>
                </div>
                <div slot="footer" style="display: inline-block">
                    <i-button type="primary" @click="applyJoin('applyJoinForm')" style="float:right;">OK</i-button>
                    <i-button @click="closeApplyJoinModel()" style="float:right;margin-right: 15px;">Cancel
                    </i-button>
                </div>
            </Modal>
            <Modal v-model="applyJoinModal" title="Apply to join the project">
                <i-form ref="applyValidate" :model="applyValidate" :rules="applyRuleValidate" :label-width="80">
                    <form-item label="Reason" prop="reason">
                        <i-input
                                v-model="applyValidate.reason"
                                type="textarea"
                                :rows="4"
                                placeholder="Enter The Reason For Application ..."
                        ></i-input>
                    </form-item>
                </i-form>
                <div slot="footer">
                    <i-button @click="applyJoinModal=false">Cancel</i-button>
                    <i-button type="success" @click="joinApply('applyValidate')">Apply</i-button>
                </div>
            </Modal>
            <Modal
                    v-model="resetProjectTypeNotice"
                    title="Reset workspace type"
            >
                <h2>Please confirm that all subprojects have been deleted.</h2>
                <div slot="footer">
                    <i-button type="primary" @click="resetProjectTypeNotice=false">OK</i-button>
                </div>
            </Modal>
            <Modal
                    v-model="resetProjectTypeModel"
                    title="Reset workspace type"
            >
                <h2>Are you sure to reset the workspace type?</h2>
                <div slot="footer">
                    <i-button type="primary" @click="resetProjectType()">Submit</i-button>
                </div>
            </Modal>
        </div>
</div>
</template>
<div th:replace="navigation::commonFooter"></div>
</div>
<script th:inline="javascript">
    var projectInfo = [[${projectInfo}]];
</script>
<script>

    var vm = new Vue(
        {
            el: "#projectDetailPage",
            components: {
                'avatar': VueAvatar.Avatar
            },
            created() {
                var userInfo = {
                    userState: false,
                    userName: 'visitor',
                    userId: '',
                    avatar: ''
                };
                sessionStorage.setItem('userInfo', JSON.stringify(userInfo));
                this.tokenStr = this.getURLParameter("token");
                if (this.tokenStr != null) {
                    $.ajax({
                        url: "/GeoProblemSolving/token/checkShareToken" + "?shareToken=" + this.tokenStr,
                        type: "GET",
                        async: false,
                        success: data => {
                            if (data) {
                                this.userRole = 'Token';
                            }
                        },
                        error: function (err) {
                            console.log("Check token info fail.");
                        }
                    });

                }
                $.ajax({
                    url: "/GeoProblemSolving/user/state",
                    type: "POST",
                    async: false,
                    success: data => {
                        if (data) {
                            data.userState = true;
                            sessionStorage.setItem('userInfo', JSON.stringify(data));
                        } else {
                            console.log("Not logged in");
                            if (this.userRole != "Token") {
                                window.location.href = '/GeoProblemSolving/login';
                            }
                        }
                    },
                    error: function (err) {
                        console.log("Get user info fail.");
                    }
                });
                this.userInfo = JSON.parse(sessionStorage.getItem("userInfo"));
                // if (this.userInfo == null || !this.userInfo.userState) {
                //     window.location.href = '/GeoProblemSolving/login';
                // }
                if (window.location.host == "localhost:8080") {
                    this.ipPort = 'http://localhost:8080';
                }
            },
            mounted() {
                this.userEnter();
                this.resizeContent();
                this.roleIdentity();
                this.changeMenuByUrl();
            },
            data() {
                return {
                    userRole: "visitor",
                    ipPort: "/GeoProblemSolving",
                    tokenStr: '',
                    userInfo: {
                        userState: false,
                        userName: 'visitor',
                        userId: '',
                        avatar: '',
                    },
                    projectInfo: projectInfo,
                    activeMenu: "overview",
                    workspaceUrl: '/GeoProblemSolving/projectInfo/' + this.projectInfo.aid + "?content=workspace",
                    contentPageCSS: '',
                    membersContentCSS: '',
                    workspaceCSS: '',
                    scrollOps: {
                        bar: {
                            background: "#808695"
                        }
                    },
                    subProjectList: [],
                    editProjectModal: false,
                    projectEditForm: {
                        description: "",
                        name: "",
                        privacy: "",
                        editTags: ""
                    },
                    editProjectFormRuleValidate: {
                        category: [
                            {
                                required: true,
                                message: "The project description cannot be empty",
                                trigger: "blur"
                            }
                        ],
                        name: [
                            {
                                required: true,
                                message: "The name cannot be empty and no more than 60 characters",
                                trigger: "blur",
                                max: 60
                            }
                        ],
                        description: [
                            {
                                required: true,
                                message:
                                    "The description cannot be empty and no more than 360 characters",
                                trigger: "blur",
                                max: 500
                            }
                        ],
                        privacy: [
                            {
                                required: true,
                                message: "The project privacy cannot be empty",
                                trigger: "blur"
                            }
                        ],
                    },
                    pictureUrl: "",
                    inputTag: "",
                    visible: false,
                    removeProjectModal: false,
                    inviteModal: false,
                    emailInfo: {
                        inputEmail: "",
                        emailTitle: "",
                        emailContent: ""
                    },
                    emailInfoRule: {
                        inputEmail: [
                            {
                                required: true,
                                type: "email",
                                message: "Incorrect email format",
                                trigger: "blur"
                            }
                        ],
                        emailTitle: [
                            {
                                required: true,
                                message: "The title cannot be empty",
                                trigger: "blur"
                            }
                        ],
                        emailContent: [
                            {
                                required: true,
                                message: "The content cannot be empty",
                                trigger: "blur"
                            }
                        ]
                    },
                    emailAddStr:
                        "<br>Please copy the url and access it to join us: <br>" +
                        "http://" +
                        window.location.host +
                        "/GeoProblemSolving/join/" +
                        projectInfo.aid +
                        "/",
                    prompt: [],
                    deleteMemberModel: false,
                    removeMemberName: "",
                    removeMemberAlertModel: false,
                    removeMemberId: "",
                    createSubProjectModel: false,
                    createSubProjectForm: {
                        subProjectTitle: "",
                        subProjectDescription: ""
                    },
                    createSubprojectRuleValidate: {
                        subProjectTitle: [
                            {
                                required: true,
                                message: "The title can't be empty and no more than 60 characters",
                                trigger: "blur",
                                type: "string",
                                max: 60
                            }
                        ],
                        subProjectDescription: [
                            {
                                required: true,
                                message: "The description can't be empty",
                                trigger: "blur"
                            }
                        ]
                    },
                    selectSubProjectIndex: 0,
                    subProjectMembers: [],
                    handOverModal: false,
                    newManagerId: "",
                    editSubProjectModal: false,
                    editSubProjectForm: {
                        subProjectTitleEdit: "",
                        subProjectDescriptionEdit: ""
                    },
                    editSubProjectFormRuleValidate: {
                        subProjectTitleEdit: [
                            {
                                required: true,
                                message: "The title can't be empty and no more than 60 characters",
                                trigger: "blur",
                                max: 60
                            }
                        ],
                        subProjectDescriptionEdit: [
                            {
                                required: true,
                                message: "The description can't be empty",
                                trigger: "blur"
                            }
                        ]
                    },
                    deleteSubProjectModal: false,
                    applyJoinSubProjectModal: false,
                    applyJoinForm: {
                        reasonDescription: ""
                    },
                    applyJoinFormRuleValidate: {
                        reasonDescription: [
                            {
                                required: true,
                                message: "The description can't be empty",
                                trigger: "blur"
                            }
                        ]
                    },
                    //
                    applyProjectInfo: {},
                    applyValidate: {
                        reason: ""
                    },
                    applyRuleValidate: {
                        reason: [
                            {required: true, message: "Please enter the reason for application", trigger: "blur"},
                            {type: "string", min: 5, message: "The reason no less than 10 characters", trigger: "blur"}
                        ]
                    },
                    applyJoinModal: false,
                    haveApplied: false,
                    resetProjectTypeNotice: false,
                    resetProjectTypeModel: false,
                    workPanels: [],
                }
            },
            watch: {
                activeMenu(val) {
                    if (val == "workspace" && this.projectInfo.type != "" && this.projectInfo.type != "Activity_Unit") {
                        this.workPanels.forEach(function (e) {
                            e.normalize();
                        });
                    } else {
                        this.workPanels.forEach(function (e) {
                            e.minimize();
                        });
                    }
                }
            },
            methods: {
                permissionIdentity(operation) {
                    return permissionIdentity(JSON.parse(this.projectInfo.permission), this.userRole, operation);
                },
                changeMenuByUrl() {
                    var content = this.getURLParameter("content");
                    if (content != null) {
                        var array = ["overview", "info", "task", "workspace", "resource"];
                        if (array.includes(content)) {
                            this.activeMenu = content;
                        }
                    }
                },
                getURLParameter(name) {
                    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                    var r = window.location.search.substr(1).match(reg);
                    if (r != null) {
                        return unescape(r[2]);
                    }
                    return null;
                },
                userEnter() {
                    if (this.userRole != "Token") {
                        if (!this.userInfo.userState) {
                            window.location.href = "/GeoProblemSolving/login";
                        } else {
                            if (this.projectInfo.privacy != "Public" && this.userRole == "visitor") {
                                window.location.href = "/GeoProblemSolving/projectList";
                            }
                        }

                    }
                },
                roleIdentity() {
                    let role = roleIdentify(this.projectInfo.members, this.userInfo.userId);

                    if (role == "visitor") {
                        if (this.userRole != 'Token') {
                            this.userRole = role;
                        }
                    } else {
                        this.userRole = role;
                    }
                },
                resizeContent() {
                    if (window.innerHeight > 735) {
                        this.membersContentCSS = window.innerHeight - 330 + 'px';
                        this.contentPageCSS = window.innerHeight - 130 + 'px';
                        this.workspaceCSS = window.innerHeight - 240 + 'px';
                    } else {
                        this.membersContentCSS = '407px';
                        this.contentPageCSS = 'fit-content';
                        this.workspaceCSS = '495px';
                    }
                    window.onresize = () => {
                        return (() => {
                            this.resizeContent();
                            this.$refs.navigationEl.identityMenuCSS();
                            if (this.$refs.folderTreeEl != undefined) {
                                this.$refs.folderTreeEl.resizeContent();
                            }
                        })()
                    }
                },
                SubProjectCount() {
                    return this.subProjectList.length;
                },
                ParticipantsCount() {
                    return (this.projectInfo.members.length + 1);
                },
                sendNotice(recipientId) {
                    this.$refs.navigationEl.sendMessage(recipientId);
                },
                changeMenuItem(name) {
                    this.activeMenu = name;
                    var tokenParam = '';
                    if (this.tokenStr != null) {
                        tokenParam = "&token=" + this.tokenStr;
                    }
                    if (name == "workspace") {
                        window.history.replaceState(null, null, this.workspaceUrl);
                    } else {
                        window.history.replaceState(null, null, '/GeoProblemSolving/projectInfo/' + this.projectInfo.aid + "?content=" + name + tokenParam);
                    }
                },
                memberListStr(members) {
                    let membersStr = '';
                    for (let i = 0; i < members.length; i++) {
                        if (i == 0) {
                            membersStr += members[i].userName;
                        } else {
                            membersStr += ',' + members[i].userName;
                        }
                    }
                    return membersStr;
                },
                editModelShow() {
                    this.editProjectModal = true;
                    let editProjectInfo = this.projectInfo;
                    this.projectEditForm.name = editProjectInfo.name;
                    this.projectEditForm.description = editProjectInfo.description;
                    this.projectEditForm.category = editProjectInfo.category;
                    this.projectEditForm.privacy = editProjectInfo.privacy;
                    this.pictureUrl = editProjectInfo.picture;

                    var tags = editProjectInfo["tag"].split(",");
                    if (tags[0] == "") {
                        this.projectEditForm.editTags = [];
                    } else {
                        this.projectEditForm.editTags = tags;
                    }
                },
                closeEditModel() {
                    this.editProjectModal = false;
                },
                uploadPhoto(e) {
                    // fileReaderfile
                    var file = e.target.files[0];
                    var filesize = file.size;
                    // 2,621,440   2M
                    if (filesize > 2101440) {
                        // 2MB
                        this.$Message.error("size > 2MB");
                    } else {
                        var reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = e => {
                            // base64  
                            let formData = new FormData();
                            formData.append("picture", file);
                            axios
                                .post("/GeoProblemSolving/resource/projectPic", formData)
                                .then(res => {
                                    if (res.data != "Fail") {
                                        this.pictureUrl = res.data;
                                        $('#choosePicture').val('');
                                    } else {
                                        this.$Message.error("upload picture Fail!");
                                    }
                                })
                                .catch();
                        };
                    }
                },
                handleView() {
                    this.visible = true;
                },
                handleRemove() {
                    this.pictureUrl = "";
                },
                addTag(tag) {
                    if (tag != "") {
                        this.projectEditForm.editTags.push(tag);
                    }
                    this.inputTag = "";
                },
                deleteTag(index) {
                    this.projectEditForm.editTags.splice(index, 1);
                },
                editProjectSubmit(form) {

                    this.$refs[form].validate(valid => {
                        if (valid) {
                            let form = {
                                aid: this.projectInfo.aid,
                                name: this.projectEditForm.name,
                                category: this.projectEditForm.category,
                                description: this.projectEditForm.description,
                                tag: this.projectEditForm.editTags,
                                privacy: this.projectEditForm.privacy,
                                picture: this.pictureUrl,
                                creator: this.userInfo.userId,
                            };
                            axios
                                .put("/GeoProblemSolving/project ", form)
                                .then(res => {
                                    if (res.data == "Offline") {
                                        this.$refs.navigationEl.logout("login");
                                    } else if (res.data.code == 0) {
                                        var newProjectInfo = res.data.data;
                                        this.editProjectModal = false;
                                        this.projectInfo = newProjectInfo;
                                        $('#projectTitle').html(newProjectInfo.name);
                                        $('#projectDescription').html(newProjectInfo.description);
                                        $('#projectPrivacy').html(newProjectInfo.privacy);
                                        $('#projectCategory').html(newProjectInfo.category);
                                        $('#projectTag').html(newProjectInfo.tag);
                                    } else {
                                        this.$Message.error(res.data.msg);
                                    }
                                })
                                .catch(err => {
                                    console.log(err.data);
                                });
                        } else {
                            this.$Message.warning("please check your form again!");
                        }
                    });
                },
                deleteProjectShow() {
                    this.removeProjectModal = true;
                },
                deleteProject() {
                    axios
                        .get(
                            "/GeoProblemSolving/project/delete?" +
                            "projectId=" +
                            this.projectInfo.aid
                        )
                        .then(res => {
                            if (res.data == "Offline") {
                                this.$refs.navigationEl.logout("login");
                            } else if (res.data == "Fail") {
                                this.$Notice.error({
                                    title: "Error",
                                    desc: "Delete project fail."
                                });
                            }
                            if (res.data == "Success") {
                                this.$Notice.success({
                                    title: "Success",
                                    desc: "Delete project successfully."
                                });
                                window.location.href = '/GeoProblemSolving/projectList';
                            }
                        })
                        .catch(err => {
                        });
                },
                inviteModalShow() {
                    this.inviteModal = true;
                    this.emailInfo.emailContent =
                        "hello, it's my pleasure to invite you join in the project called " +
                        this.projectInfo.name +
                        ".";
                },
                invite(name) {
                    this.$refs[name].validate(valid => {
                        if (valid) {
                            var emailFormBody = {};
                            emailFormBody["recipient"] = this.emailInfo.inputEmail;
                            emailFormBody["mailTitle"] = this.emailInfo.emailTitle;
                            emailFormBody["mailContent"] =
                                this.emailInfo.emailContent + this.emailAddStr;
                            axios
                                .post("/GeoProblemSolving/email/invite", emailFormBody)
                                .then(res => {
                                    if (res.data == "Success") {
                                        this.$Notice.success({
                                            desc:
                                                "The invitation has been sent successfully."
                                        });
                                        this.inviteModal = false;
                                    } else {
                                        this.$Notice.error({
                                            desc: "Failed to send the invitation."
                                        });
                                    }
                                })
                                .catch(err => {
                                    console.log(err.data);
                                });
                        } else {
                            this.$Message.info("Form check!");
                        }
                    });
                },
                closeInviteModel() {
                    this.inviteModal = false;
                },
                emialAutoFill(value) {
                    this.prompt =
                        !value || value.indexOf("@") >= 0
                            ? []
                            : [
                                value + "@gmail.com",
                                value + "@sina.com",
                                value + "@163.com",
                                value + "@126.com",
                                value + "@qq.com"
                            ];
                },
                deleteMemberModelShow() {
                    this.removeMemberId = "";
                    this.removeMemberName = "";
                    this.deleteMemberModel = true;
                },
                closeDeleteMembersModel() {
                    this.deleteMemberModel = false;
                },
                removeMembersAlertShow() {
                    if (this.removeMemberName != '') {
                        this.removeMemberAlertModel = true;
                    } else {
                        this.$Message.warning("There are no member be selected.");
                    }
                },
                getRemoveMemberId(userId) {
                    this.removeMemberId = userId;
                },
                removeMember() {
                    axios
                        .get(
                            "/GeoProblemSolving/project/quit" +
                            "?projectId=" +
                            this.projectInfo.aid +
                            "&userId=" +
                            this.removeMemberId
                        )
                        .then(res => {
                            if (res.data == "Offline") {
                                this.$refs.navigationEl.logout("login");
                            } else if (res.data == "None") {
                                this.$Notice.warning({
                                    title: "Operate result",
                                    desc: "The project doesn't exist."
                                });
                            } else {
                                this.$Notice.success({
                                    title: "Operate result",
                                    desc: "The member has been removed from the project successfully."
                                });
                                this.deleteMemberModel = false;
                                var members = this.projectInfo.members;
                                for (var i = 0; i < members.length; i++) {
                                    if (members[i].userId == this.removeMemberId) {
                                        this.projectInfo.members.splice(i, 1);
                                        break;
                                    }
                                }
                            }
                        })
                        .catch(err => {
                        });
                },
                goPersonalPage(userId) {
                    if (userId == this.userInfo.userId) {
                        window.location.href = "/GeoProblemSolving/personalPage";
                    } else {
                        window.location.href = "/GeoProblemSolving/memberPage/" + userId;
                    }
                },
                modifyPermission() {
                    window.location.href = "/GeoProblemSolving/project/" + this.projectInfo.aid + "/permission";
                },
                resetProjectTypeModalShow() {
                    if (this.subProjectList.length > 0) {
                        this.resetProjectTypeNotice = true;
                    } else {
                        this.resetProjectTypeModel = true;
                    }
                },
                resetProjectType() {
                    this.projectInfo.type = "";
                    axios
                        .put("/GeoProblemSolving/project", this.projectInfo)
                        .then(res => {
                            this.resetProjectTypeModel = false;
                            if (res.data == "Offline") {
                                window.location.href = "/GeoProblemSolving/login"
                            } else if (res.data.code == 0) {
                                // sessionStorage.setItem("projectInfo", JSON.stringify(res.data));
                                // sessionStorage.setItem("projectInfo", this.encrypto(res.data));
                                this.projectInfo = res.data.data;
                            } else {
                                this.$Message.error(res.data.msg);
                            }
                        })
                        .catch(err => {
                            console.log(err.data);
                        });
                },
                showSubProjectCreateModel() {
                    this.createSubProjectModel = true;
                },
                closeCreateSubProjectModel() {
                    this.createSubProjectModel = false;
                },
                createSubProject(form) {
                    // this.$refs[form].validate(valid => {
                    //     if (valid) {
                    //         let SubProject = {};
                    //         SubProject[
                    //             "description"
                    //             ] = this.createSubProjectForm.subProjectDescription;
                    //         SubProject["title"] = this.createSubProjectForm.subProjectTitle;
                    //         SubProject["projectId"] = this.projectInfo.aid;
                    //         SubProject["managerId"] = this.userInfo.userId;
                    //         SubProject["type"] = "";
                    //         SubProject["stepId"] = "";
                    //         axios
                    //             .post("/GeoProblemSolving/subProject/create", SubProject)
                    //             .then(res => {
                    //                 if (res.data == "Offline") {
                    //                     this.$refs.navigationEl.logout("login");
                    //                 } else if (res.data != "Fail") {
                    //                     this.$Notice.success({
                    //                         title: "Create result",
                    //                         desc: "Subproject has been created successfully."
                    //                     });
                    //                     this.createSubProjectForm.subProjectTitle = "";
                    //                     this.createSubProjectForm.subProjectDescription = "";
                    //                     this.subProjectList.push(res.data);
                    //                     this.createSubProjectModel = false;
                    //                 } else {
                    //                     this.$Message.info("fail");
                    //                 }
                    //             })
                    //             .catch(err => {
                    //             });
                    //     } else {
                    //         this.$Message.error("Please check your form again!");
                    //     }
                    // });
                },
                handOverModalShow(index) {
                    this.selectSubProjectIndex = index;
                    this.subProjectMembers = this.subProjectList[index].members;
                    this.handOverModal = true;
                },
                closeHandOverModel() {
                    this.handOverModal = false;
                },
                handOverAuthority() {
                    axios
                        .get(
                            "/GeoProblemSolving/subProject/manager?" +
                            "aid=" +
                            this.subProjectList[this.selectSubProjectIndex].aid +
                            "&userId=" +
                            this.newManagerId
                        )
                        .then(res => {
                            if (res.data == "Offline") {
                                this.$refs.navigationEl.logout("login");
                            } else if (res.data != "Fail") {
                                this.subProjectList.splice(this.selectSubProjectIndex, 1, res.data);
                                this.$Message.success("Handover management authority success!");
                                //
                                let replyNotice = {};
                                replyNotice["recipientId"] = this.newManagerId;
                                replyNotice["type"] = "notice";
                                replyNotice["content"] = {
                                    title: "Subproject manager",
                                    description:
                                        "You have already become the manager of subproject: " +
                                        this.subProjectList[this.selectSubProjectIndex].title +
                                        "."
                                };
                                axios
                                    .post("/GeoProblemSolving/notice/save", replyNotice)
                                    .then(result => {
                                        if (result.data == "Success") {
                                            this.sendNotice(this.newManagerId);
                                            this.handOverModal = false;
                                        } else {
                                            this.$Message.error("notice fail.");
                                        }
                                    })
                                    .catch(err => {
                                        this.$Message.error("notice fail.");
                                    });
                            } else {
                                this.$Message.error("Handover management authority failed.");
                            }
                        })
                        .catch(err => {
                            console.log(err.data);
                        });
                },
                editSubProjectModalShow(index) {
                    this.selectSubProjectIndex = index;
                    this.editSubProjectModal = true;
                    this.editSubProjectForm.subProjectTitleEdit = this.subProjectList[index].title;
                    this.editSubProjectForm.subProjectDescriptionEdit = this.subProjectList[index].description;
                },
                closeEditSubProjectModel() {
                    this.editSubProjectModal = false;
                },
                editSubProject(form) {
                    // this.$refs[form].validate(valid => {
                    //     if (valid) {
                    //         this.editSubProjectModal = false;
                    //         let obj = new URLSearchParams();
                    //         obj.append(
                    //             "aid",
                    //             this.subProjectList[this.selectSubProjectIndex].aid
                    //         );
                    //         obj.append("title", this.editSubProjectForm.subProjectTitleEdit);
                    //         obj.append(
                    //             "description",
                    //             this.editSubProjectForm.subProjectDescriptionEdit
                    //         );
                    //         axios
                    //             .post("/GeoProblemSolving/subProject/update", obj)
                    //             .then(res => {
                    //                 if (res.data == "Offline") {
                    //                     this.$refs.navigationEl.logout("login");
                    //                 } else if (res.data != "Fail") {
                    //                     this.subProjectList.splice(this.selectSubProjectIndex, 1, res.data);
                    //                 } else {
                    //                     this.$Message.error("Update subproject failed.");
                    //                 }
                    //             })
                    //             .catch(err => {
                    //                 console.log(err.data);
                    //             });
                    //     } else {
                    //         this.$Message.warning("Please check your form again!");
                    //     }
                    // });
                },
                deleteSubProjectModalShow(index) {
                    this.selectSubProjectIndex = index;
                    this.deleteSubProjectModal = true;
                },
                deleteSubProject() {
                    // var deletedSubProjectId = this.subProjectList[this.selectSubProjectIndex].aid;
                    // axios
                    //     .get(
                    //         "/GeoProblemSolving/subProject/delete?" +
                    //         "aid=" +
                    //         deletedSubProjectId
                    //     )
                    //     .then(res => {
                    //         if (res.data == "Offline") {
                    //             this.$refs.navigationEl.logout("login");
                    //         } else if (res.data == "Success") {
                    //             this.subProjectList.splice(this.selectSubProjectIndex, 1);
                    //             this.$Message.success("Delete subproject success!");
                    //         } else {
                    //             this.$Message.error("Delete subproject failed.");
                    //         }
                    //     })
                    //     .catch(err => {
                    //         console.log(err.data);
                    //     });
                },
                applyJoinSubProjectModalShow(index) {
                    this.selectSubProjectIndex = index;
                    this.applyJoinSubProjectModal = true;
                },
                closeApplyJoinModel() {
                    this.applyJoinSubProjectModal = false;
                },
                joinSubProject(index) {
                    let subProject = this.subProjectList[index];
                    this.axios.get("/GeoProblemSolving/subProject/join?aid=" + subProject.aid + '&userId=' + this.userInfo.userId)
                        .then(res => {
                            if (res.data !== "Fail" && res.data !== "None") {
                                this.$Notice.success({
                                    title: 'Success notice',
                                    desc: 'Now you are a member of this subproject.',
                                });
                                window.location.href = "/GeoProblemSolving/project/" + subProject.aid + "/subproject";
                            }
                        })
                        .catch(err => {
                            console.log(err.data);
                        })
                },
                applyJoin(form) {
                    // this.$refs[form].validate(valid => {
                    //     if (valid) {
                    //         this.applyJoinSubProjectModal = false;
                    //         var subProject = this.subProjectList[this.selectSubProjectIndex];
                    //         let joinSubPForm = {};
                    //         joinSubPForm["recipientId"] = subProject.managerId;
                    //         joinSubPForm["type"] = "apply";
                    //         let userDetail = this.userInfo;
                    //         joinSubPForm["content"] = {
                    //             userEmail: userDetail.email,
                    //             userName: userDetail.userName,
                    //             userId: userDetail.userId,
                    //             title: "Group application",
                    //             description:
                    //             "User " +
                    //             userDetail.userName +
                    //             " apply to join in your subproject: " +
                    //             subProject.name +
                    //             " of project: " +
                    //             this.projectInfo.name +
                    //             " .",
                    //             projectId: subProject.aid,
                    //             projectTitle: subProject.name,
                    //             scope: "subProject",
                    //             approve: "unknow"
                    //         };
                    //         axios
                    //             .post("/GeoProblemSolving/notice/save", joinSubPForm)
                    //             .then(res => {
                    //                 this.$Message.info("Apply Successfully");
                    //                 this.sendNotice(subProject.managerId);
                    //             })
                    //             .catch(err => {
                    //                 console.log("" + err.data);
                    //             });
                    //         let joinSubProjectEmail = {};
                    //         joinSubProjectEmail["recipient"] = subProject.managerId;
                    //         joinSubProjectEmail["mailTitle"] = "Join sub project application";
                    //         joinSubProjectEmail["mailContent"] =
                    //             "User " +
                    //             userDetail.userName +
                    //             " apply to join in your subproject: " +
                    //             subProject.title +
                    //             " of project: " +
                    //             this.projectInfo.name +
                    //             " ." +
                    //             " And you can access the subproject from this platform. " +
                    //             "The url is " +
                    //             "http://" +
                    //             window.location.host +
                    //             "/GeoProblemSolving/home";
                    //
                    //         axios
                    //             .post("/GeoProblemSolving/project/applyByMail", joinSubProjectEmail)
                    //             .then(res => {
                    //                 if (res.data == "Success") {
                    //                     this.$Notice.success({
                    //                         title: "Email send title",
                    //                         desc:
                    //                             "The join email has been sent,if he/she doesn't online,the email will remind the mamnager in time."
                    //                     });
                    //                 } else {
                    //                     this.$Notice.error({
                    //                         title: "Email send fail",
                    //                         desc: "The invitation isn't be sent successfully."
                    //                     });
                    //                 }
                    //             })
                    //             .catch(err => {
                    //                 console.log(err.data);
                    //             });
                    //     }
                    // });
                },
                goSubProjectPage(subProject) {
                    // if(this.projectInfo.permission != undefined
                    //     && this.projectInfo.permission.observe.visitor == "Yes"){
                    //     window.location.href = "/GeoProblemSolving/project/" + subProject.aid + "/subproject/info";
                    // } else {
                    //     if (this.userRole != "visitor") {
                    //         window.location.href = "/GeoProblemSolving/project/" + subProject.aid + "/subproject/info";
                    //     } else {
                    //         this.$Message.warning({
                    //             render: h => {
                    //                 return h('div', [
                    //                     h('p', 'Sorry, you are not allowed to enter this subproject.'),
                    //                     h('h3', 'Please apply to join first.'),
                    //                 ])
                    //             }
                    //         });
                    //     }
                    // }
                },
                goResourceCenter() {
                    window.location.href = "/GeoProblemSolving/resourceCenter";
                },
                joinApplyModalShow() {
                    if (this.userInfo.userState) {
                        this.applyProjectInfo = Object.assign([], this.projectInfo);

                        // join the project directly
                        if (this.applyProjectInfo.permission != undefined && this.applyProjectInfo.permission.auto_join.visitor) {
                            axios
                                .get("/GeoProblemSolving/project/" + this.applyProjectInfo.aid + "/user?" + "userId=" + this.userInfo.userId)
                                .then(res => {
                                    if (res.data.code == 0) {
                                        this.$Message.info("Join this project successfully");
                                        window.location.href = "/GeoProblemSolving/projectInfo/" + this.applyProjectInfo.aid;
                                    } else {
                                        this.$Message.info(res.data.msg);
                                    }
                                })
                                .catch(err => {
                                    console.log(err.data);
                                });
                        } else {
                            this.applyValidate.reason = "";
                            this.applyJoinModal = true;
                        }
                    } else {
                        confirm("Please login first.");
                    }
                },
                joinApply(name) {
                    this.$refs[name].validate(valid => {
                        if (valid) {
                            this.applyJoinModal = false;
                            if (
                                this.haveApplied == true &&
                                this.applyProjectInfo.aid == sessionStorage.getItem("applyId")
                            ) {
                                return;
                            } else {
                                let description = "User " +
                                    userDetail.userName +
                                    " apply to join your project: " +
                                    this.applyProjectInfo.name +
                                    " ." +
                                    " The reason for application is: " +
                                    this.applyValidate.reason;
                                let userDetail = this.userInfo;
                                for (var i = 0; i < this.applyProjectInfo.members.length; i++) {
                                    if (this.applyProjectInfo.members[i].role == "manager") {
                                        let managerId = this.applyProjectInfo.members[i].userId;
                                        let joinForm = {};
                                        joinForm["recipientId"] = managerId;
                                        joinForm["type"] = "apply";
                                        joinForm["content"] = {
                                            userEmail: userDetail.email,
                                            userName: userDetail.userName,
                                            userId: userDetail.userId,
                                            title: "Group application",
                                            description: description,
                                            projectId: this.applyProjectInfo.aid,
                                            projectTitle: this.applyProjectInfo.name,
                                            scope: "project",
                                            approve: "unknow"
                                        };

                                        axios
                                            .post("/GeoProblemSolving/notice/save", joinForm)
                                            .then(res => {
                                                if (res.data == "Success") {
                                                    this.$Notice.open({
                                                        title: "Apply Successfully",
                                                        desc:
                                                            "The application has been sent to managers of the project."
                                                    });
                                                    this.$emit("sendNotice", managerId);
                                                    this.haveApplied = true;
                                                } else {
                                                    this.$Notice.open({
                                                        desc: "Apply failed."
                                                    });
                                                }
                                            })
                                            .catch(err => {
                                                console.log("" + err.data);
                                            });
                                    }
                                }
                                sessionStorage.setItem("applyId", this.applyProjectInfo.aid);

                                let emailObject = {
                                    mailTitle: "Project application",
                                    mailContent:
                                        description + "<br>" +
                                        "You can click this url and enter the site to process this application: " +
                                        "http://" + window.location.host + "/GeoProblemSolving/home"
                                };
                                axios
                                    .post("/GeoProblemSolving/project/" + this.applyProjectInfo.aid + "/application", emailObject)
                                    .then(res => {
                                        if (res.data.code !== 0) {
                                            console.log(res.data.msg);
                                        }
                                    })
                                    .catch(err => {
                                        console.log(err.data);
                                    });
                            }
                        } else {
                            this.$Message.error("Fail!");
                        }
                    });
                },
                showToolPanel(url, title) {
                    var that = this;
                    var panel = jsPanel.create({
                        container: "#pageBody",
                        theme: "success",
                        headerTitle: title,
                        footerToolbar: '<p style="height:10px"></p>',
                        contentSize: "800 400",
                        content: url,
                        disableOnMaximized: true,
                        dragit: {
                            containment: 5
                        },
                        closeOnEscape: true,
                        onbeforeclose: function (panel, status, closedByUser) {
                            return confirm("Please confirm your edit has been saved?");
                        },
                        onclosed: function (panel, status, closedByUser) {
                            var index = that.workPanels.indexOf(this);
                            that.workPanels.splice(index, 1);
                        },
                    });
                    $(".jsPanel-content").css("font-size", "0");//
                    $(".jsPanel").css("position", "fixed");
                    this.workPanels.push(panel);
                },
            }
        }
    );
</script>
</body>
</html>
