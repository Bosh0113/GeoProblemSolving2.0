<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head >
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <title>Geo-Problem Solving</title>
    <link rel="shortcut icon" href="/GeoProblemSolving/static/favicon.ico">
    <meta http-equiv="Content-Type" content=" charset=UTF-8" />
    <meta name="description" content="Participatory|GeoProblem Solving|GIS">
    <meta name="keywords" content="Participatory|GeoProblem Solving|GIS">
    <meta name="author" content="OpenGMS">
    <script src="/GeoProblemSolving/js/jquery.js"></script>
    <script src="/GeoProblemSolving/js/vue.min.js"></script>
    <link href="/GeoProblemSolving/css/iview.css" rel="stylesheet">
    <script src="/GeoProblemSolving/js/iview.js"></script>
    <script src="/GeoProblemSolving/js/vue-avatar.min.js"></script>
    <script src="/GeoProblemSolving/js/axios.min.js"></script>


    <script th:replace="navigation :: commonHeader-css"></script>
    <script th:replace="navigation :: commonHeader-html"></script>
    <script th:replace="navigation :: commonHeader-js"></script>

    <script th:replace="tabContent :: tab-card"></script>
    <style th:replace="tabContent :: tab-style"></style>
    <script th:replace="tabContent :: tab-component"   th:inline="javascript"></script>

    <style >
        [v-cloak]{
            display: none;
        }
        .picscreen {
            position: relative;
        }

        .picbg {
            background-image: url("Images/projectlist.png");
            background-size: cover;
            position: absolute;
            height: 140px;
            width: 100%;
            background-color: #8b8b8b;
            top: 0;
            left: 0;
        }

        .pictitle{
            font-size: 1.6rem;
            font-family: Georgia, sans-serif, serif;
            position: absolute;
            top: 18px;
            left: 100px;
        }
        .picdesc{
            font-size: 0.9rem;
            position: absolute;
            top: 72px;
            left: 100px;
            display: block;
            width: 700px;
        }
        .project-start-btn{
            position: absolute;
            top: 80px;
            left: 70%;
            font-size: 0.9rem;
            border-radius: 6px;
            background-color: rgba(21, 88, 145, 0.8);
            color: rgba(255,255,255,1);
            width: 150px;
        }
        .search-btn{
            position: absolute;
            top: 30px;
            right: 50px;
            font-size: 0.5rem;
            width: 150px;
            text-align:left;
        }

        /*Tabs--style*/
        .tabs{
            transform: translateY(60px);
            min-height: 500px;
        }
        .tabpane-syle{
            font-size: 20px;
            background-color: rgba(133, 115, 92, 0.1);
            min-height: 500px;
        }
        .ivu-tabs-bar {
            /*border-bottom: 1px solid #dddee1;*/
            margin-bottom: 0px;
        }
        .ivu-tabs-nav-wrap {
            text-align: center;
            margin-bottom:0px;
        }
        .ivu-tabs-nav-scroll {
            margin-left:5%;
        }
        .ivu-tabs-tab{
            font-size: 16px;
        }
        .ivu-row{
            margin-bottom: 45px;
        }

        .pro-page{
            bottom:  75px;
            left:43%;
            font-size:14px;
            text-align: center;
            /*margin-top: 200px;*/
        }

        .tab-content {
            /* transform: translateY(140px); */
            margin-top: 140px;
        }
    </style>
</head>
<body>
<div id="vueBody" v-cloak style="min-width: 1100px;">
   <child-navigation ref="navigationEl" active-type="projects" :user-info="userInfo"></child-navigation>
    <div class="tabs">
        <Row :style="{minHeight:contentMinHeight+'px'}">
            <i-col>
                <div class="pro-tab">
                    <Tabs  v-model="currentTab" @on-click="changeTab" >
                        <tab-pane label="All" name="All" icon="md-list"></tab-pane>
                        <tab-pane label="Investigational" name="Investigational" icon="md-globe"></tab-pane>
                        <tab-pane label="Intercomparable" name="Intercomparable" icon="md-git-compare"></tab-pane>
                        <tab-pane label="Reproducible" name="Reproducible" icon="ios-copy"></tab-pane>
                        <tab-pane label="Educational" name="Educational" icon="ios-paper"></tab-pane>
                    </Tabs>
                </div>
                <div class="picscreen" >
                    <div class="picbg"></div>
                    <div class="home-content">
                        <div>
                            <span class="pictitle">{{selectCatalog.name}}</span>
                            <span class="picdesc">{{selectCatalog.introduction}}</span>
                            <i-button class="project-start-btn" @click="newProject"  type="default" >Create a project</i-button>
                            <i-button class="search-btn" icon="icon ion-ios-search" @click=" ">Search...</i-button>
                        </div>
                    </div>
                </div>
                <div class="pro-content">
                    <tab-content class="tab-content" :project-list = tabPageData @sendNotice="sendMessage" :key="freshEle"></tab-content >
                </div>
            </i-col>

        </Row>
        <div class="pro-page" >
            <Page  ref="pages" :total="totalCount" :page-size="pageSize"  :current="currentPage" size="small"  @on-change="changePage"   show-elevator show-total ></Page>
        </div>
        <div th:replace="navigation::commonFooter"></div>

    </div>
    </div>

    <script th:inline="javascript">
    window.onload=function () {
        var projectsInfo = [[${projectsInfo}]];
        new Vue({
            el: '#vueBody',
            data: {
                currentProjectList:  projectsInfo.projectList,
                projectType:[],
                currentTab:"All",
                //初始化信息总条数
                //projectCount:10,
                contentMinHeight:0,
                currentPage:1 ,
                totalCount:projectsInfo.count,
                //每页显示多少条
                pageSize:18,
                tabPageData:projectsInfo.projectList,
                tabPaneType:[{  label:"All",name:"All",icon:"icon ion-md-list"},
                    {label: "Investigational", name: "Investigational", icon: "icon ion-md-globe"},
                    {label: "Intercomparable", name: "Intercomparable", icon: "icon ion-md-git-compare"},
                    {label: "Reproducible", name: "Reproducible", icon: "icon ion-ios-copy"},
                    {label: "Educational", name: "Educational", icon: "icon ion-ios-paper"}
                ],
                projectCatalog:[
                    {name:"All projects", introduction:"All different types of are listed here, including investigational projects, intercomparable projects, reproducible projects, and educational projects. Select the project that you need."},
                    {name:"Investigational projects", introduction:"Understanding geographic scales and boundaries, clarifying geographic factors, analyzing geographic phenomena, and simulating geographic processes"},
                    {name:"Intercomparable projects", introduction:"Intercomparable projects"},
                    {name:"Reproducible projects", introduction:"Reproducible projects"},
                    {name:"Educational projects", introduction:"Educational projects"},
                ],
                selectCatalog:{name:"All projects", introduction:"All different types of are listed here, including investigational projects, intercomparable projects, reproducible projects, and educational projects. Select the project that you need."},
                // user
                userInfo:[],
                userState:false,
                freshEle:0
            },
            created(){
                var userInfo = {
                    userState: false,
                    userName: 'visitor',
                    userId: '',
                    avatar: ''
                };
                sessionStorage.setItem('userInfo', JSON.stringify(userInfo));
                $.ajax({
                    url: "/GeoProblemSolving/user/state",
                    type: "POST",
                    async: false,
                    success: data=> {
                        if (data) {
                            data.userState = true;
                            sessionStorage.setItem('userInfo', JSON.stringify(data));
                        } else {
                            console.log("Not logged in");
                        }
                    },
                    error: function (err) {
                        console.log("Get user info fail.");
                    }
                });
            },
            mounted(){
                this.resizeContent();
                //判断用户状态，如果登录，判断project权限，如果否，不判断
                this.userInfo=JSON.parse(sessionStorage.getItem("userInfo"));
                if( this.userInfo != null&&this.userInfo.userState){
                    this.userState=true;
                    this.changePage(1);
                }
                else{
                    this.userState=false;
                    this.judgeMember(projectsInfo.projectList);
                    this.tabPageData=Object.assign([], projectsInfo.projectList);
                    this.freshEle++;
                }
                window.onresize = () => {
                    return (() => {
                        this.$refs.navigationEl.identityMenuCSS();
                        this.resizeContent();
                    })()
                }
            },

            methods: {
                resizeContent(){
                    this.contentMinHeight = window.innerHeight-100.38;
                },
                changeTab(type) {
                    this.currentTab=type;
                    this.currentPage=1;
                    this.$nextTick(function(){
                        this.$refs['pages'].currentPage = 1;
                    });

                    if(type=="All"&& !this.userState){
                        this.judgeMember(projectsInfo.projectList);
                        this.tabPageData=Object.assign([],  this.currentProjectList);
                        this.freshEle++;
                        this.totalCount=projectsInfo.count;
                        this.selectCatalog = this.projectCatalog[0];
                    }
                    else{
                        if(type == "Investigational"){
                            this.selectCatalog = this.projectCatalog[1];
                        }
                        else if(type == "Intercomparable"){
                            this.selectCatalog = this.projectCatalog[2];
                        }
                        else if(type == "Reproducible"){
                            this.selectCatalog = this.projectCatalog[3];
                        }
                        else if(type == "Educational"){
                            this.selectCatalog = this.projectCatalog[4];
                        }
                        this.changePage(1);
                    }

                },

                changePage(index){
                    if(this.currentTab == "All" && index==1 && !this.userState){
                        this.judgeMember(projectsInfo.projectList);
                        this.tabPageData=Object.assign([],  this.currentProjectList);
                        this.freshEle++;
                        this.totalCount=projectsInfo.count;
                    }
                    else {
                        let userId = "";
                        let joinedProjects = [];
                        if(this.userState){
                            userId = this.userInfo.userId;
                            for(let i = 0; i < this.userInfo.joinedProjects.length; i++) {
                                joinedProjects.push(this.userInfo.joinedProjects[i].projectId);
                            }
                        }
                        // this.$Spin.show();
                        axios
                            .get("/GeoProblemSolving/project/inquiryByPage"+
                                    "?category="+this.currentTab+
                                    "&page="+index+
                                    "&pageSize="+this.pageSize+
                                    "&userId="+userId+
                                    "&joinedProjects="+joinedProjects)
                            .then(res => {
                                // this.$Spin.hide();
                                if(res.data !="Fail") {
                                    if (res.data === "None") {
                                        this.currentProjectList = [];
                                    }
                                    else{
                                        this.judgeMember(res.data.projectList);
                                    }
                                    this.tabPageData = Object.assign([], this.currentProjectList);
                                    this.totalCount=res.data.count;
                                    this.freshEle++;
                                }
                                else{
                                    console.log("Fail");
                                }
                            })
                            .catch(err => {
                                console.log(err.data);
                            });
                    }
                },

                judgeMember(list) {
                    let projectList = list;
                    //判断登录状态
                    if(this.userState == true){
                        if (projectList.length != 0) {
                            for (var i = 0; i < projectList.length; i++) {
                                let managerId = projectList[i].managerId;
                                let members = projectList[i].members;
                                if (managerId ==  this.userInfo.userId) {
                                    projectList[i]["isManager"] = true;
                                } else {
                                    projectList[i]["isManager"] = false;
                                }
                                if (members.length != 0) {
                                    for (var j = 0; j < members.length; j++) {
                                        if (members[j].userId ==  this.userInfo.userId) {
                                            projectList[i]["isMember"] = true;
                                            break;
                                        } else {
                                            projectList[i]["isMember"] = false;
                                        }
                                    }
                                } else {
                                    projectList[i]["isMember"] = false;
                                }
                            }
                            this.currentProjectList = Object.assign([],projectList);
                        }
                        else{
                            this.currentProjectList=[];
                        }
                    }
                    else{
                        if (projectList.length != 0) {
                            for (var i = 0; i < projectList.length; i++) {
                                let managerId = projectList[i].managerId;
                                let members = projectList[i].members;
                                projectList[i]["isManager"] = false;
                                projectList[i]["isMember"] = false;
                            }
                            this.currentProjectList = Object.assign([],projectList);
                        }
                        else{
                            this.currentProjectList=[];
                        }
                    }
                },
                newProject() {
                    if (this.userState == false) {
                        window.location.href = "/GeoProblemSolving/login"
                    } else {
                        window.location.href = "/GeoProblemSolving/newProject"
                    }
                },
                sendMessage(recipientId){
                    this.$refs.navigationEl.sendMessage(recipientId);
                }
            }
        })
    }
</script>

</body>
</html>