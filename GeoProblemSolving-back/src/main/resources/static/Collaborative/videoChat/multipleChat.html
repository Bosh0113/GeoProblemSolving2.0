<!DOCTYPE html>
<html>
<head >
    <title>Multiple video chat</title>
    <meta http-equiv="Content-Type" content=" charset=UTF-8" />
    <meta name="description" content="Participatory|GeoProblem Solving|GIS">
    <meta name="keywords" content="Participatory|GeoProblem Solving|GIS">
    <meta name="author" content="OpenGMS">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
    <link href="https://cdn.bootcss.com/iview/3.4.2/styles/iview.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/iview/3.4.2/iview.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-avatar@2.1.7/dist/vue-avatar.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style >
    </style>

</head>

<body>
<div id="vueBody" v-cloak style="min-width: 1100px">
    <div>
        <h1>Online members:</h1>
        <p v-for="member in participants" :key="member.index">{{member.userName}}</p>
        <h1>Chating members:</h1>
        <p v-for="chatUser in chatingUsers" :key="chatUser.index">{{chatUser.userName}}</p>
    </div>
    <i-button @click="applyToJoin" :disabled="applyDisabled">Join chat</i-button>
    <i-button @click="quitFromChat" :disabled="!applyDisabled">Quit chat</i-button>
    <h1>Video list:</h1>
    <div v-show="localVideoShow">
        <Row>
            <i-col span="8" style="padding: 15px">
                <div style="height: 80%;width: 100%;padding: 5px">
                    <video id="localVideo" autoplay="autoplay" src="" controls="controls" style="width:100%;height:100%">
                        local video
                    </video>
                </div>
                <div style="height:20%;text-align: center">
                    <h4>You</h4>
                </div>
            </i-col>
            <i-col span="8" style="padding: 15px">
                <div style="height: 80%;width: 100%;padding: 5px">
                    <video id="remoteVideo" autoplay="autoplay" src="" controls="controls" style="width:100%;height:100%">
                        remote video
                    </video>
                </div>
                <div style="height:20%;text-align: center">
                    <h4>Remote</h4>
                </div>
            </i-col>
            <i-col span="8" style="padding: 15px" v-for="chatVideo in chatVideos" :key="chatVideo.index">
                <div style="height: 80%;width: 100%;padding: 5px">
                    <video :id="chatVideo.userId" autoplay="autoplay" src="" controls="controls" style="width:100%;height:100%">
                        remote videos
                    </video>
                </div>
                <div style="height:20%;text-align: center">
                    <h4>{{chatVideo.userName}}</h4>
                </div>
            </i-col>
        </Row>
    </div>
</div>

<script>
    const configuration = {"iceServers": [
        {"url": "stun:stun.l.google.com:19302"},
        // TURN 一般需要自己去定义
        {
            'url': 'turn:223.2.40.150:3478?transport=udp',
            'credential': 'JZEOEt2V3Qb0y27GRntt2u2PAYA=',
            'username': '28224511:1379330808'
        }
    ]};
    var constraints = { audio: false, video: true };
    new Vue({
        el: '#vueBody',
        data:{
            pageParams:{},
            videoChatSocket: null,
            participants:[],
            chatingUsers:[],
            applyDisabled:false,
            localVideoShow:false,
            chatVideos:[],
            peerConnection:null,
            localStream:null,
            remoteView:null,
            remoteStream:null
        },
        created(){
            this.getPageInfo();
        },
        mounted(){
            this.remoteView = document.getElementById('remoteVideo');
            this.initWebSocket();
        },
        methods: {
            getPageInfo(){
                var href = window.location.href;
                var url = href.split("&");

                for (var i = 0; i < url.length; i++) {
                    if (/groupID/.test(url[i])) {
                        this.pageParams.pageId = url[i].match(/groupID=(\S*)/)[1];
                        continue;
                    }

                    if (/userID/.test(url[i])) {
                        this.pageParams.userId = url[i].match(/userID=(\S*)/)[1];
                        continue;
                    }

                    if (/userName/.test(url[i])) {
                        this.pageParams.userName = url[i].match(/userName=(\S*)/)[1];
                        continue;
                    }
                }
            },
            initWebSocket(){
                if(this.videoChatSocket!=null){
                    this.videoChatSocket = null;
                }
                var socketUrl = "wss://"+ window.location.hostname +":8083/GeoProblemSolving/VideoChatSignalSocket/"+this.pageParams.pageId;
                this.videoChatSocket = new WebSocket(socketUrl);
                this.videoChatSocket.onopen = this.onOpen;
                this.videoChatSocket.onmessage = this.onMessage;
                this.videoChatSocket.onclose = this.onClose;
                this.videoChatSocket.onerror = this.onError;
            },
            onOpen(){
                console.log("Socket连接成功！");
                this.sendMessage("connect",{});
                this.initiate();
            },
            async onMessage(evt){
                var messageObject = JSON.parse(evt.data);
                switch(messageObject.type){
                    case "members":{
                        this.participants = messageObject.memberList;
                        this.chatingUsers = messageObject.chatList;
                        break;
                    }
                    case "apply":{
                        console.log("Someone apply to chat with you.");
                        //增加视频窗口
                        var newVideo = {
                            userId:messageObject.userInfo.userId,
                            userName:messageObject.userInfo.userName,
                            videoUid:messageObject.content.videoUid
                        }
                        this.chatVideos.push(newVideo);
                        //设置请求者远程视频
                        this.applySetRemoteConfig(messageObject);
                        break;
                    }
                    case "candidate":{
                        console.log("[接收candidate]: " + messageObject.content.candidate);
                        if (messageObject.content.candidate != null) {
                            await this.peerConnection.addIceCandidate(await new RTCIceCandidate(messageObject.content.candidate));
                        }
                        break;
                    }
                    case "reply":{
                        console.log("Someone reply you.");
                        //增加视频窗口
                        var newVideo = {
                            userId:messageObject.userInfo.userId,
                            userName:messageObject.userInfo.userName,
                            videoUid:messageObject.content.videoUid
                        }
                        this.chatVideos.push(newVideo);
                        //设置接收者远程视频
                        this.replySetRemoteConfig(messageObject);
                        break;
                    }
                    case "quit":{
                        var quitUserId = messageObject.userInfo.userId;
                        for(var i=0;i<this.chatVideos.length;i++){
                            if(this.chatVideos[i].userId==quitUserId){
                                this.chatVideos.splice(i,1);
                                break;
                            }
                        }
                    }
                }
            },
            onClose(){
                this.closeConnection();
                console.log("Socket连接断开！");
            },
            onError(){
                this.closeConnection();
                console.log("Socket连接错误！");
            },
            sendMessage(type, content){
                var userId = this.pageParams.userId;
                var userName = this.pageParams.userName;
                var message ={
                    type: type,
                    userInfo:{
                        userId: userId,
                        userName: userName
                    },
                    content: content
                }
                this.videoChatSocket.send(JSON.stringify(message));
            },
            applyToJoin(){
                //设置本地视频窗口
                this.setLocalConfig();
            },
            quitFromChat(){
                this.sendMessage("quit", {});
                this.closeConnection();
                this.chatVideos=[];
                this.applyDisabled = false;
                this.localVideoShow = false;
            },
            initiate(){
                // 浏览器适配
                let audioContext;
                if (typeof AudioContext === 'function') {
                    audioContext = new AudioContext();
                } else if (typeof webkitAudioContext === 'function') {
                    audioContext = new webkitAudioContext(); // eslint-disable-line new-cap
                } else {
                    console.log('Sorry! Web Audio not supported.');
                }

                // 视频过滤节点
                var filterNode = audioContext.createBiquadFilter();
                // see https://dvcs.w3.org/hg/audio/raw-file/tip/webaudio/specification.html#BiquadFilterNode-section
                filterNode.type = 'highpass';  //高通
                // cutoff frequency: for highpass, audio is attenuated below this frequency 截止频率
                filterNode.frequency.value = 10000;

                // create a gain node (to change audio volume) 控制音量 小于1表示音量衰减，反之亦然
                var gainNode = audioContext.createGain();
                // default is 1 (no change); less than 1 means audio is attenuated
                // and vice versa
                gainNode.gain.value = 0.5;


                // 判断是否有 navigator.mediaDevices，没有赋成空对象
                if (navigator.mediaDevices === undefined) {
                    navigator.mediaDevices = {};
                }

                navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
                this.peerConnection = new RTCPeerConnection(configuration);
                this.peerConnection.ontrack = (event) => {
                    // don't set srcObject again if it is already set.
                    this.remoteStream = event.streams[0];
                    if ('srcObject' in this.remoteView)
                    {
                        this.remoteView.srcObject = this.remoteStream;
                    }
                    else {
                        this.remoteView.src = window.URL.createObjectURL(this.remoteStream);
                    }
                    this.remoteView.play();
                };

                this.peerConnection.onicecandidate = ({candidate}) =>
                {
                    console.log("[发送的candidate] " + JSON.stringify({"type":"candidate","value":candidate}))
                    var content = {
                        candidate: candidate
                    }
                    this.sendMessage("candidate",content);
                };

                this.peerConnection.oniceconnectionstatechange = function (event) {
                    if (this.peerConnection.iceConnectionState === "failed" ||
                    this.peerConnection.iceConnectionState === "disconnected" ||
                    this.peerConnection.iceConnectionState === "closed") {
                        console.error(event);
                        console.error("Connection interruption please refresh");
                    }
                };

            },
            async setLocalConfig(){
                try {
                    var localView = document.getElementById('localVideo');
                    // get local stream, show it in self-view and add it to be sent
                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    var that = this;
                    this.localStream.getTracks().forEach((track) =>
                        this.peerConnection.addTrack(track, that.localStream));
                    if ('srcObject' in localView) { // 判断是否支持 srcObject 属性
                        localView.srcObject = this.localStream;
                    } else {
                        localView.src = window.URL.createObjectURL(this.localStream);
                    }
                } catch (err) {
                    alert("系统未检测到摄像头!");
                    console.error(err);
                }
                await this.peerConnection.createOffer().then( offer => {
                    return this.peerConnection.setLocalDescription(new RTCSessionDescription(offer));
                });
                var content = {
                    videoUid:this.peerConnection.localDescription
                }
                this.sendMessage("apply", content);
                this.applyDisabled = true;
                this.localVideoShow = true;
            },
            async applySetRemoteConfig(messageObject){
                if (messageObject.content.videoUid != null ){
                    await this.peerConnection.setRemoteDescription(messageObject.content.videoUid);
                }
                try {
                    var localView = document.getElementById('localVideo');
                    // get local stream, show it in self-view and add it to be sent
                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    if ('srcObject' in localView) { // 判断是否支持 srcObject 属性
                        localView.srcObject = this.localStream;
                    } else {
                        localView.src = window.URL.createObjectURL(this.localStream);
                    }
                    var that = this;
                    await this.localStream.getTracks().forEach((track) => that.peerConnection.addTrack(track, that.localStream));
                } catch (err) {
                    alert("系统未检测到摄像头!");
                    console.error(err);
                }
                await this.peerConnection.createAnswer().then((answer)=> {
                    that.peerConnection.setLocalDescription(new RTCSessionDescription(answer))
                });
                //构建reply消息
                var applyerId = messageObject.userInfo.userId;
                var content = {
                    replyTo: applyerId,
                    videoUid:this.peerConnection.localDescription
                }
                this.sendMessage("reply", content);
                this.remoteView.onloadedmetadata = ()=>{
                    this.remoteView.play();
                }
            },
            async replySetRemoteConfig(messageObject){
                if (messageObject.content.videoUid != null ){
                    await this.peerConnection.setRemoteDescription(messageObject.content.videoUid);
                }
            },
            closeConnection() {
                var that = this;
                if(that.remoteStream!=null){
                    const tracks = this.localStream.getTracks().concat(that.remoteStream.getTracks());
                    tracks.forEach((track) => {
                        track.stop();
                    });
                }
                this.peerConnection.close();
                this.initiate();
            }
        }
    })
</script>


</body>